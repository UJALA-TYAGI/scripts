package main

import (
	"fmt"
	"os/exec"
	"strings"
)

func GetImagePaths() []string {
	imagePaths := make([]string, 0)

	// Function to extract images from a given command output
	extractImages := func(cmd *exec.Cmd, grepPattern string) []string {
		var images []string
		pipe, err := cmd.StdoutPipe()
		if err != nil {
			fmt.Println("Error creating stdout pipe:", err)
			return images
		}
		defer pipe.Close()

		grepCmd := exec.Command("grep", grepPattern)
		grepCmd.Stdin = pipe

		if err := cmd.Start(); err != nil {
			fmt.Println("Error starting command:", err)
			return images
		}

		out, err := grepCmd.Output()
		if err != nil {
			fmt.Println("Error running grep command:", err)
			return images
		}

		imageLines := strings.Split(string(out), "\n")
		for _, imageLine := range imageLines {
			splitted := strings.Split(imageLine, ":")
			if len(splitted) == 2 && strings.TrimSpace(splitted[0]) == "image" {
				image := strings.Replace(splitted[1], "container-external", "container-release", 1)
				images = append(images, image)
			}
		}
		return images
	}

	// Extract images from the Helm template file
	helmCmd := exec.Command("helm", "template", "-f", "manifest/kyverno-values.yml", "manifests/kyverno")
	images := extractImages(helmCmd, "containerregistry")
	imagePaths = append(imagePaths, images...)

	// Extract images from the kustomization file
	kustomizeCmd := exec.Command("grep", "image:", "manifests/overlays/alpha-ida-dev/kustomization.yml")
	images = extractImages(kustomizeCmd, "image:")
	imagePaths = append(imagePaths, images...)

	return imagePaths
}

func main() {
	imagePaths := GetImagePaths()
	for _, path := range imagePaths {
		fmt.Println(path)
	}
}
